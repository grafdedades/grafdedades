<html>
<head>
  <title>Hugo</title>
  <meta charset="utf-8" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
</head>
<style>
  svg {
    height: 1000px;
    width: 1000px;
    margin-left: auto;
    margin-right: auto;
    display:block;
  }
  div.tooltip {
    position: absolute;
    text-align: left;
    width: 120px;
    height: 60px;
    padding: 2px;
    font: 12px sans-serif;
    background: lightsteelblue;
    border: 0px;
    border-radius: 8px;
    pointer-events: none;
}

</style>
<body>

  <svg id = "svg">
  </svg>

</body>
  <footer>
<script>

d3.json("data/data.json", function(error,data) {createNetwork(data)})

function createNetwork(json) {
  // Map of node info throw its label
  var nodeHash = {};
  // Lists of nodes and edges (only important info for the network construction)
  var nodes = [];
  var edges = [];

  json.nodes.forEach(function (node) {
    nodeHash[node.label] = {id: node.id, label: node.label, year: node.year};
    nodes.push(nodeHash[node.label]);
  });

  json.edges.forEach(function (edge) {
    edges.push({source: nodeHash[edge.source], target: nodeHash[edge.target], weight: edge.weight, place: edge.place, date: edge.date, comments: edge.comments});
  });
  createForceNetwork(nodes, edges);

}

function createForceNetwork(nodes, edges) {

//create a network from an edgelist
  var colors = {"2019" : "#42A5F5", "2018" : "#66BB6A" , "2017" : "#E57373"}

  var force = d3.layout.force().nodes(nodes).links(edges)
  .size([1000,1000])
  .charge(-200)
  .linkDistance(60)
  .on("tick", updateNetwork);

  var div = d3.select("body").append("div")
    .attr("class", "tooltip")
    .style("opacity", 0);

  var search = d3.select("body").append("input")
    .attr("id","search_bar")

  var search_button = d3.select("body").append("input")
    .attr("type","button")
    .attr("id","search_button")
    .text("Search")

  d3.select("svg").selectAll("line")
  .data(edges)
  .enter()
  .append("line")
  .on("mouseover", function(d) {
            div.transition()
                .duration(200)
                .style("opacity", .9);
            div.html("<b>Place: </b>" + d.place + "<br/>" + "<b>Date: </b>" + d.date + "<br/>" + "<b>Comments: </b>" + d.comments)
                .style("left", (d3.event.pageX) + "px")
                .style("top", (d3.event.pageY - 28) + "px");
            })
  .on("mouseout", function(d) {
            div.transition()
                .duration(500)
                .style("opacity", 0);
        })
  .style("stroke-width", function (d) {return d.weight})
  .style("stroke", "#000000");

  var nodeEnter = d3.select("svg").selectAll("g.node")
  .data(nodes)
  .enter()
  .append("g")
  .attr("class", "node")
  .on("click", nodeClick)
  .on("dblclick", nodeDoubleClick)
  .on("mouseover", nodeOver)
  .on("mouseout", nodeOut)
  .call(force.drag());

  d3.select("search_button").selectAll("g.node")
  .data(nodes)
  .enter()
  .append("g")
  .attr("class", "node")
  .on("click", SearchNode)
  .call(force.drag());


  nodeEnter.append("circle")
  .attr("r", 10)
  .style('fill', function(d) {
    return colors[d.year];
  })
  .style("stroke", "black")
  .style("opacity", "1");

  nodeEnter.append("text")
   .style("text-anchor", "middle")
   .attr("y", 20)
   .style("stroke-width", "1px")
   .style("stroke-opacity", 0.75)
   .style("stroke", "white")
   .style("font-size", "14px")
   .text(function (d) {return d.label})
   .style("pointer-events", "none")

   nodeEnter.append("text")
   .style("text-anchor", "middle")
   .attr("y", 20)
   .style("font-size", "14px")
    .style("opacity", "1")
   .text(function (d) {return d.label})
   .style("pointer-events", "none")

  force.start();

    function nodeOut() {
      force.start();
      d3.selectAll("circle")
      .style('fill', function(d) {
        return colors[d.year];
      })
      .style("opacity", "1");

      d3.selectAll("line")
      .style("stroke", "#000000")
      .style("stroke-width", function (d) {return d.weight})
      .style("opacity", "1")

      d3.selectAll("text")
      .style("text-anchor", "middle")
      .style("opacity", "1")
      .attr("y", 20)
      .text(function (d) {return d.label})
    }
    function nodeClick(d) {
      d.fixed = true;
    }
  function nodeDoubleClick(d) {
    d.fixed = false;
  }
  function nodeOver(d) {
    force.stop();
    nodeF(d);
  }

  function nodeF(d) {
    var egoIDs = [];
    var filteredEdges = edges.filter(function (p) {return p.source == d || p.target == d});
    egoIDs.push(d.id)
    filteredEdges
    .forEach(function (p) {
      if (p.source == d) {
        egoIDs.push(p.target.id)
      }
      else {
        egoIDs.push(p.source.id)
      }
    });

    d3.selectAll("line").filter(function (p) {return filteredEdges.indexOf(p) == -1})
    .style("opacity", "0.3")
    .style("stroke-width", "1")

    d3.selectAll("text").filter(function (p) {return egoIDs.indexOf(p.id) == -1})
    .style("opacity", "0")

    d3.selectAll("circle").filter(function (p) {return egoIDs.indexOf(p.id) == -1})
    .style("fill", "#66CCCC")
    .style("opacity", "0.3");

  }

  function nodeOver(d) {
    force.stop();
    nodeF(d);
  }

  function updateNetwork() {
    d3.select("svg").selectAll("line")
    .attr("x1", function (d) {return d.source.x})
    .attr("y1", function (d) {return d.source.y})
    .attr("x2", function (d) {return d.target.x})
    .attr("y2", function (d) {return d.target.y});

    d3.select("svg").selectAll("g.node")
      .attr("transform", function (d) {return "translate(" + d.x + "," + d.y + ")"});

  }
}

</script>
  </footer>

</html>
